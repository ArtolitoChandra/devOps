name: Complete CI/CD Pipeline - Docker + Kubernetes

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

env:
  DOCKER_IMAGE: alexcang/dapoerjengsri
  KUBERNETES_NAMESPACE: default

jobs:
  # Job 1: Build and Test
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Validate HTML files
        run: |
          echo "‚úÖ Validating HTML structure..."
          if [ -f "dapoerjengsriweb/index.html" ]; then
            echo "‚úÖ index.html found"
          else
            echo "‚ùå Error: index.html not found"
            exit 1
          fi
      
      - name: Check CSS files
        run: |
          echo "‚úÖ Checking CSS files..."
          if [ -f "dapoerjengsriweb/style.css" ]; then
            echo "‚úÖ style.css found"
          else
            echo "‚ùå Error: style.css not found"
            exit 1
          fi
      
      - name: Check JavaScript files
        run: |
          echo "‚úÖ Checking JavaScript files..."
          if [ -f "dapoerjengsriweb/script.js" ]; then
            echo "‚úÖ script.js found"
          else
            echo "‚ùå Error: script.js not found"
            exit 1
          fi

  # Job 2: Build and Push Docker Image
  docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ env.DOCKER_IMAGE }}:latest,${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}:latest
          cache-to: type=inline
      
      - name: Image digest
        run: echo "‚úÖ Docker image pushed successfully to ${{ env.DOCKER_IMAGE }}"

  # Job 3: Deploy to Kubernetes (LOCAL)
  deploy-kubernetes-local:
    name: Deploy to Local Kubernetes
    runs-on: ubuntu-latest
    needs: docker
    if: github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'
      
      - name: Create kubeconfig (for demo purposes)
        run: |
          echo "‚ö†Ô∏è Note: This step would normally connect to your K8s cluster"
          echo "For local testing, you would use: kubectl config use-context docker-desktop"
          echo "Simulating deployment check..."
          
      - name: Validate Kubernetes manifests
        run: |
            echo "‚úÖ Validating Kubernetes deployment files..."
            kubectl apply --dry-run=client --validate=false -f kubernetes/deployment.yaml
            kubectl apply --dry-run=client --validate=false -f hpa-dapoerjengsri.yaml
            echo "‚úÖ Kubernetes manifests syntax is valid!"
        
      
      - name: Deployment Summary
        run: |
          echo "üì¶ Docker Image: ${{ env.DOCKER_IMAGE }}:latest"
          echo "üöÄ Ready for Kubernetes deployment"
          echo "üí° To deploy locally, run: kubectl apply -f kubernetes/"

  # Job 4: Monitoring Check
  monitoring-check:
    name: Check Monitoring Configuration
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Validate Prometheus config
        run: |
          if [ -f "monitoring/prometheus.yml" ]; then
            echo "‚úÖ Prometheus configuration found"
          else
            echo "‚ö†Ô∏è Warning: Prometheus config not found"
          fi
      
      - name: Check monitoring setup
        run: |
          echo "‚úÖ Monitoring Stack:"
          echo "  - Prometheus: Port 9090"
          echo "  - Grafana: Port 3000"
          echo "  - Metrics Server: Kubernetes"

  # Job 5: Final Notification
  notify:
    name: Deployment Status
    runs-on: ubuntu-latest
    needs:
      - build
      - docker
      - deploy-kubernetes-local
      - monitoring-check
    if: always()
    
    steps:
      - name: Success Notification
        if: |
          needs.build.result == 'success' &&
          needs.docker.result == 'success' &&
          needs.deploy-kubernetes-local.result == 'success'
        run: |
          echo "üéâ =================================="
          echo "üéâ CI/CD PIPELINE COMPLETED!"
          echo "üéâ =================================="
          echo ""
          echo "‚úÖ Build: Success"
          echo "‚úÖ Docker Image: Built and Pushed"
          echo "‚úÖ Kubernetes: Validated"
          echo "‚úÖ Monitoring: Configured"
          echo ""
          echo "üöÄ Your application is ready for deployment!"
      
      - name: Failure Notification
        if: failure()
        run: |
          echo "‚ùå =================================="
          echo "‚ùå PIPELINE FAILED!"
          echo "‚ùå =================================="
          echo "Please check the logs above for details."